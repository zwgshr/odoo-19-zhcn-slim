name: åˆå§‹åŒ– Odoo 19.0 é•œåƒåˆ†æ”¯

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - name: å…‹éš†ä¸Šæ¸¸ Odoo ä»“åº“ï¼ˆ19.0 åˆ†æ”¯ï¼‰
        run: |
          git clone \
            --filter=blob:none \
            --depth=1 \
            --branch 19.0 \
            --single-branch \
            --no-tags \
            https://github.com/odoo/odoo.git \
            upstream
          cd upstream
          echo "UPSTREAM_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "UPSTREAM_DATE=$(git log -1 --format=%cI)" >> $GITHUB_ENV
          echo "UPSTREAM_TITLE=$(git log -1 --format=%s)" >> $GITHUB_ENV

      - name: åˆ é™¤ä¸Šæ¸¸ .github ç›®å½•
        run: |
          cd upstream
          rm -rf .github

      - name: æ¸…ç†éä¸­æ–‡ç¿»è¯‘æ–‡ä»¶
        run: |
          cd upstream
          # åˆ é™¤æ‰€æœ‰ .po æ–‡ä»¶ï¼Œä½†ä¿ç•™ zh_CN.po
          find . -type f -name "*.po" ! -name "zh_CN.po" -delete
          # ä¿ç•™æ‰€æœ‰ .pot æ–‡ä»¶ï¼ˆä¸åˆ é™¤ï¼‰
          echo "ç¿»è¯‘æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: åˆå§‹åŒ–æ–°ä»“åº“å¹¶åˆ›å»ºå­¤å„¿åˆ†æ”¯
        run: |
          cd upstream
          
          # ç§»é™¤ä¸Šæ¸¸çš„ git å†å²
          rm -rf .git
          
          # åˆå§‹åŒ–æ–°çš„ git ä»“åº“
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # åˆ›å»ºåˆå§‹æäº¤
          UPSTREAM_SHA="${{ env.UPSTREAM_SHA }}"
          UPSTREAM_DATE="${{ env.UPSTREAM_DATE }}"
          UPSTREAM_TITLE="${{ env.UPSTREAM_TITLE }}"
          
          git commit -m "åˆå§‹åŒ– Odoo 19.0 ä¸­æ–‡ç²¾ç®€é•œåƒ

          ä»ä¸Šæ¸¸ä»“åº“åŒæ­¥å¹¶æ¸…ç†éä¸­æ–‡ç¿»è¯‘æ–‡ä»¶ã€‚

          Upstream-Repository: https://github.com/odoo/odoo
          Upstream-Branch: 19.0
          Upstream-Commit: ${UPSTREAM_SHA}
          Upstream-Date: ${UPSTREAM_DATE}
          Upstream-Title: ${UPSTREAM_TITLE}
          Upstream-Compare: https://github.com/odoo/odoo/compare/${UPSTREAM_SHA}...19.0"
          
          # æ·»åŠ  git notesï¼ˆå¯é€‰ï¼‰
          git notes add -m "Upstream: odoo/odoo@${UPSTREAM_SHA}
          Date: ${UPSTREAM_DATE}
          Title: ${UPSTREAM_TITLE}"

      - name: æ¨é€åˆ° 19.0 åˆ†æ”¯
        run: |
          cd upstream
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git branch -M 19.0
          git push -f origin 19.0
          
          # æ¨é€ notesï¼ˆå¯é€‰ï¼‰
          git push origin refs/notes/commits || true

      - name: å®Œæˆé€šçŸ¥
        run: |
          echo "âœ… Odoo 19.0 é•œåƒåˆ†æ”¯åˆå§‹åŒ–å®Œæˆï¼"
          echo "ğŸ“Œ ä¸Šæ¸¸ Commit: ${{ env.UPSTREAM_SHA }}"
          echo "ğŸ“… ä¸Šæ¸¸æ—¥æœŸ: ${{ env.UPSTREAM_DATE }}"
          echo "ğŸ“ æäº¤æ ‡é¢˜: ${{ env.UPSTREAM_TITLE }}"


