name: åŒæ­¥ Odoo 19.0 ä¸Šæ¸¸æ›´æ–°

on:
  schedule:
    # æ¯å‘¨ä¸€ UTC 00:00 è¿è¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“çš„ 19.0 åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: "19.0"
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¿ç•™æäº¤è®°å½•

      - name: è¯»å–ä¸Šæ¬¡åŒæ­¥çš„ commit SHA
        id: last_sync
        run: |
          # ä»æœ€æ–°çš„ commit message ä¸­æå–ä¸Šæ¸¸ commit SHA
          LAST_SHA=$(git log -1 --pretty=%B | grep -oP '(?<=Upstream-Commit: )[a-f0-9]+' || echo "")
          if [ -n "${LAST_SHA}" ]; then
            echo "last_sha=${LAST_SHA}" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ ä¸Šæ¬¡åŒæ­¥çš„ commit: ${LAST_SHA}"
          else
            echo "last_sha=" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ°ä¸Šæ¬¡åŒæ­¥è®°å½•ï¼Œå°†æ‰§è¡Œå®Œæ•´åŒæ­¥"
          fi

      - name: å…‹éš†ä¸Šæ¸¸ Odoo ä»“åº“ï¼ˆ19.0 åˆ†æ”¯ï¼‰
        run: |
          git clone \
            --filter=blob:none \
            --depth=1 \
            --branch 19.0 \
            --single-branch \
            --no-tags \
            https://github.com/odoo/odoo.git \
            upstream
          cd upstream
          UPSTREAM_SHA=$(git rev-parse HEAD)
          echo "UPSTREAM_SHA=${UPSTREAM_SHA}" >> $GITHUB_ENV
          echo "ğŸ“Œ ä¸Šæ¸¸æœ€æ–° commit: ${UPSTREAM_SHA}"

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        id: check_update
        run: |
          LAST_SHA="${{ steps.last_sync.outputs.last_sha }}"
          UPSTREAM_SHA="${{ env.UPSTREAM_SHA }}"
          
          if [ -n "${LAST_SHA}" ] && [ "${LAST_SHA}" = "${UPSTREAM_SHA}" ]; then
            echo "has_update=false" >> $GITHUB_OUTPUT
            echo "âœ… ä¸Šæ¸¸æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
          else
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥"
          fi

      - name: æå–ä¸Šæ¸¸å…ƒæ•°æ®
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          cd upstream
          UPSTREAM_SHA="${{ env.UPSTREAM_SHA }}"
          UPSTREAM_DATE=$(git log -1 --format=%cI)
          UPSTREAM_TITLE=$(git log -1 --format=%s)
          UPSTREAM_AUTHOR=$(git log -1 --format=%an)
          
          echo "UPSTREAM_DATE=${UPSTREAM_DATE}" >> $GITHUB_ENV
          echo "UPSTREAM_TITLE=${UPSTREAM_TITLE}" >> $GITHUB_ENV
          echo "UPSTREAM_AUTHOR=${UPSTREAM_AUTHOR}" >> $GITHUB_ENV
          
          # å¦‚æœå­˜åœ¨ä¸Šæ¬¡ SHAï¼Œç”Ÿæˆå¯¹æ¯”é“¾æ¥
          LAST_SHA="${{ steps.last_sync.outputs.last_sha }}"
          if [ -n "${LAST_SHA}" ]; then
            COMPARE_URL="https://github.com/odoo/odoo/compare/${LAST_SHA}...${UPSTREAM_SHA}"
          else
            COMPARE_URL="https://github.com/odoo/odoo/commits/${UPSTREAM_SHA}"
          fi
          echo "COMPARE_URL=${COMPARE_URL}" >> $GITHUB_ENV

      - name: åˆ é™¤ä¸Šæ¸¸ .github ç›®å½•
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          cd upstream
          rm -rf .github
          rm -rf doc

      - name: æ¸…ç†éä¸­æ–‡ç¿»è¯‘æ–‡ä»¶
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          cd upstream
          # åˆ é™¤æ‰€æœ‰ .po æ–‡ä»¶ï¼Œä½†ä¿ç•™ zh_CN.po
          find . -type f -name "*.po" ! -name "zh_CN.po" -delete
          # ä¿ç•™æ‰€æœ‰ .pot æ–‡ä»¶ï¼ˆä¸åˆ é™¤ï¼‰
          echo "âœ… ç¿»è¯‘æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: åŒæ­¥æ›´æ–°åˆ°æœ¬åœ°åˆ†æ”¯
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ä½¿ç”¨ rsync åŒæ­¥æ–‡ä»¶ï¼ˆä¿ç•™ .git ç›®å½•ï¼Œåˆ é™¤æœ¬åœ°å¤šä½™æ–‡ä»¶ï¼‰
          rsync -av --delete --exclude='.git' --exclude='upstream' upstream/ .
          
          # ç§»é™¤ä¸´æ—¶ä¸Šæ¸¸ç›®å½•
          rm -rf upstream

      - name: æäº¤æ›´æ”¹
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          UPSTREAM_SHA="${{ env.UPSTREAM_SHA }}"
          UPSTREAM_DATE="${{ env.UPSTREAM_DATE }}"
          UPSTREAM_TITLE="${{ env.UPSTREAM_TITLE }}"
          UPSTREAM_AUTHOR="${{ env.UPSTREAM_AUTHOR }}"
          LAST_SHA="${{ steps.last_sync.outputs.last_sha }}"
          COMPARE_URL="${{ env.COMPARE_URL }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            git commit -m "åŒæ­¥ä¸Šæ¸¸ Odoo 19.0 æ›´æ–°

          åŒæ­¥æ¥è‡ª odoo/odoo ä»“åº“ 19.0 åˆ†æ”¯çš„æœ€æ–°æ›´æ–°ã€‚

          Upstream-Repository: https://github.com/odoo/odoo
          Upstream-Branch: 19.0
          Upstream-Commit: ${UPSTREAM_SHA}
          Upstream-Date: ${UPSTREAM_DATE}
          Upstream-Author: ${UPSTREAM_AUTHOR}
          Upstream-Title: ${UPSTREAM_TITLE}
          Upstream-Previous: ${LAST_SHA:-N/A}
          Upstream-Compare: ${COMPARE_URL}"
            
            # æ·»åŠ  git notesï¼ˆå¯é€‰ï¼‰
            git notes add -m "Upstream: odoo/odoo@${UPSTREAM_SHA}
          Date: ${UPSTREAM_DATE}
          Author: ${UPSTREAM_AUTHOR}
          Title: ${UPSTREAM_TITLE}
          Compare: ${COMPARE_URL}" || true
            
            echo "has_changes=true" >> $GITHUB_ENV
            echo "âœ… æäº¤å·²åˆ›å»º"
          fi

      - name: æ¨é€åˆ° 19.0 åˆ†æ”¯
        if: steps.check_update.outputs.has_update == 'true' && env.has_changes == 'true'
        run: |
          # ä½¿ç”¨ GITHUB_TOKEN è¿›è¡Œè®¤è¯æ¨é€
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git 19.0
          
          # æ¨é€ notesï¼ˆå¯é€‰ï¼‰
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git refs/notes/commits || true
          
          echo "âœ… æ›´æ–°å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“"

      - name: å®Œæˆé€šçŸ¥
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          echo "âœ… Odoo 19.0 åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“Œ ä¸Šæ¸¸ Commit: ${{ env.UPSTREAM_SHA }}"
          echo "ğŸ“… ä¸Šæ¸¸æ—¥æœŸ: ${{ env.UPSTREAM_DATE }}"
          echo "ğŸ‘¤ ä¸Šæ¸¸ä½œè€…: ${{ env.UPSTREAM_AUTHOR }}"
          echo "ğŸ“ æäº¤æ ‡é¢˜: ${{ env.UPSTREAM_TITLE }}"
          echo "ğŸ”— å¯¹æ¯”é“¾æ¥: ${{ env.COMPARE_URL }}"

      - name: è·³è¿‡é€šçŸ¥
        if: steps.check_update.outputs.has_update == 'false'
        run: |
          echo "â„¹ï¸ ä¸Šæ¸¸æ— æ›´æ–°ï¼Œæœ¬æ¬¡åŒæ­¥å·²è·³è¿‡"

